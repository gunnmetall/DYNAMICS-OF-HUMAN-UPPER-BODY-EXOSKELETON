%% CARS project : Kinematic motion of lifting from ground with Forward Dynamics

clear all; clc;

weight= 85;
payload=5;
m1 = weight/10;  % mass of crus
m2 = weight/10;  % mass of thigh
m3= weight/2.5;   % mass of central body
m4= weight/20;   % mass of arm
m5= weight/20 +payload;  % mass of forearm

g=9.8; % gravitational acceleration

ts=5;    % assigned time for completion of one cycle
dt=0.05;
t=0:dt:ts;
    
th1=0 .* (1-cos(2.*pi.*t/ts)); % ankle joint
th2=0 .* (1-cos(2.*pi.*t/ts)); % knee joint
th3=0 .* (1-cos(2.*pi.*t/ts))+0.*ones(size(t)); % waist joint
th4=0 .* (1-cos(2.*pi.*t/ts))+0.*ones(size(t)); %shoulder joint
th5=pi/4.*(1-cos(2.*pi.*t/ts))+0.*ones(size(t));

th1dot=(pi^2*sin((2*pi*t)/ts))/(3*ts);
th2dot=(2*pi^2*sin((2*pi*t)/ts))/(3*ts);
th3dot=(2*pi^2*sin((2*pi*t)/ts))/(3*ts);
th4dot=(pi^2*sin((2*pi*t)/ts))/(3*ts);
th5dot=0;

th1ddot=(2*pi^3*cos((2*pi*t)/ts))/(3*ts^2);
th2ddot=(4*pi^3*cos((2*pi*t)/ts))/(3*ts^2);
th3ddot=(4*pi^3*cos((2*pi*t)/ts))/(3*ts^2);
th4ddot=(2*pi^3*cos((2*pi*t)/ts))/(3*ts^2);
th5ddot=zeros(size(th4ddot));

thddot=[ th1ddot; th2ddot; th3ddot; th4ddot; th5ddot];

waist_width=0.3; % waist width in meters
crus=0.5; % length of crus
thigh=0.5; % length of thigh
spine=0.7; % length of spine
shoulder=0.6; % width of shoulder
bicep_arm=0.4; % length of bicep arm
forearm=0.4; % length of forearm


% Forward Dynamics

tau1 = m3.*(crus.*cos(th1) + thigh.*cos(th1 - th2)).*(crus.*th1ddot.*cos(th1) - crus.*th1dot.^2.*sin(th1) + thigh.*cos(th1 - th2).*(th1ddot - th2ddot) - thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) - g.*m2.*(crus.*sin(th1) + (thigh.*sin(th1 - th2))/2) + m2.*(crus.*sin(th1) + (thigh.*sin(th1 - th2))/2).*(crus.*th1ddot.*sin(th1) + crus.*th1dot.^2.*cos(th1) + (thigh.*sin(th1 - th2).*(th1ddot - th2ddot))/2 + (thigh.*cos(th1 - th2).*(th1dot - th2dot).^2)/2) - m5.*(spine.*cos(th1 - th2 + th3) - bicep_arm.*cos(th1 - th2 + th3 - th4) + crus.*cos(th1) + thigh.*cos(th1 - th2)).*(bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) - crus.*th1ddot.*cos(th1) - spine.*cos(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*sin(th1) - thigh.*cos(th1 - th2).*(th1ddot - th2ddot) + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) + m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)).*(crus.*th1ddot.*sin(th1) - (bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot))/2 - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + m5.*(spine.*sin(th1 - th2 + th3) - bicep_arm.*sin(th1 - th2 + th3 - th4) + crus.*sin(th1) + thigh.*sin(th1 - th2) - (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1ddot.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) + (forearm.*sin(th1 - th2 + th3 - th4 - th5).*(th2ddot - th1ddot - th3ddot + th4ddot + th5ddot))/2 - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - g.*m3.*((spine.*sin(th1 - th2 + th3))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)) + m4.*(spine.*cos(th1 - th2 + th3) + crus.*cos(th1) + thigh.*cos(th1 - th2)).*(crus.*th1ddot.*cos(th1) + spine.*cos(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) - crus.*th1dot.^2.*sin(th1) + thigh.*cos(th1 - th2).*(th1ddot - th2ddot) - spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 - thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) - g.*m5.*(spine.*sin(th1 - th2 + th3) - bicep_arm.*sin(th1 - th2 + th3 - th4) + crus.*sin(th1) + thigh.*sin(th1 - th2) - (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) - g.*m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)) + m3.*((spine.*sin(th1 - th2 + th3))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)).*(crus.*th1ddot.*sin(th1) + crus.*th1dot.^2.*cos(th1) + (spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot))/2 + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) + (spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2)/2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + crus.^2.*m2.*th1ddot.*cos(th1).^2 + (crus.^2.*m1.*th1ddot.*sin(th1).^2)/4 - (crus.*g.*m1.*sin(th1))/2 + (crus.^2.*m1.*th1dot.^2.*cos(th1).*sin(th1))/4 - crus.^2.*m2.*th1dot.^2.*cos(th1).*sin(th1);
 
tau2 = g.*m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + thigh.*sin(th1 - th2)) - g.*m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) - thigh.*sin(th1 - th2) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) - m4.*(spine.*cos(th1 - th2 + th3) + thigh.*cos(th1 - th2)).*(crus.*th1ddot.*cos(th1) + spine.*cos(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) - crus.*th1dot.^2.*sin(th1) + thigh.*cos(th1 - th2).*(th1ddot - th2ddot) - spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 - thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) - m3.*((spine.*sin(th1 - th2 + th3))/2 + thigh.*sin(th1 - th2)).*(crus.*th1ddot.*sin(th1) + crus.*th1dot.^2.*cos(th1) + (spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot))/2 + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) + (spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2)/2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + m5.*(spine.*cos(th1 - th2 + th3) - bicep_arm.*cos(th1 - th2 + th3 - th4) + thigh.*cos(th1 - th2)).*(bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) - crus.*th1ddot.*cos(th1) - spine.*cos(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*sin(th1) - thigh.*cos(th1 - th2).*(th1ddot - th2ddot) + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) - m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + thigh.*sin(th1 - th2)).*(crus.*th1ddot.*sin(th1) - (bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot))/2 - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) - thigh.*sin(th1 - th2) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1ddot.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) + (forearm.*sin(th1 - th2 + th3 - th4 - th5).*(th2ddot - th1ddot - th3ddot + th4ddot + th5ddot))/2 - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + g.*m3.*((spine.*sin(th1 - th2 + th3))/2 + thigh.*sin(th1 - th2)) - m3.*thigh.*cos(th1 - th2).*(crus.*th1ddot.*cos(th1) - crus.*th1dot.^2.*sin(th1) + thigh.*cos(th1 - th2).*(th1ddot - th2ddot) - thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) + (g.*m2.*thigh.*sin(th1 - th2))/2 - (m2.*thigh.*sin(th1 - th2).*(crus.*th1ddot.*sin(th1) + crus.*th1dot.^2.*cos(th1) + (thigh.*sin(th1 - th2).*(th1ddot - th2ddot))/2 + (thigh.*cos(th1 - th2).*(th1dot - th2dot).^2)/2))/2;
 
tau3 = g.*m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) + g.*m4.*((bicep_arm.*sin(th1 - th2 + th3 - th4))/2 - spine.*sin(th1 - th2 + th3)) + m5.*(bicep_arm.*cos(th1 - th2 + th3 - th4) - spine.*cos(th1 - th2 + th3)).*(bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) - crus.*th1ddot.*cos(th1) - spine.*cos(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*sin(th1) - thigh.*cos(th1 - th2).*(th1ddot - th2ddot) + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) - m4.*((bicep_arm.*sin(th1 - th2 + th3 - th4))/2 - spine.*sin(th1 - th2 + th3)).*(crus.*th1ddot.*sin(th1) - (bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot))/2 - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1ddot.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) + (forearm.*sin(th1 - th2 + th3 - th4 - th5).*(th2ddot - th1ddot - th3ddot + th4ddot + th5ddot))/2 - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - (g.*m3.*spine.*sin(th1 - th2 + th3))/2 + m4.*spine.*cos(th1 - th2 + th3).*(crus.*th1ddot.*cos(th1) + spine.*cos(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) - crus.*th1dot.^2.*sin(th1) + thigh.*cos(th1 - th2).*(th1ddot - th2ddot) - spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 - thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) + (m3.*spine.*sin(th1 - th2 + th3).*(crus.*th1ddot.*sin(th1) + crus.*th1dot.^2.*cos(th1) + (spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot))/2 + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) + (spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2)/2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2))/2;

tau4 = m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1ddot.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) + (forearm.*sin(th1 - th2 + th3 - th4 - th5).*(th2ddot - th1ddot - th3ddot + th4ddot + th5ddot))/2 - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - g.*m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) - bicep_arm.*m5.*cos(th1 - th2 + th3 - th4).*(bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) - crus.*th1ddot.*cos(th1) - spine.*cos(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*sin(th1) - thigh.*cos(th1 - th2).*(th1ddot - th2ddot) + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) + (bicep_arm.*m4.*sin(th1 - th2 + th3 - th4).*(crus.*th1ddot.*sin(th1) - (bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot))/2 - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2))/2 - (bicep_arm.*g.*m4.*sin(th1 - th2 + th3 - th4))/2;

tau5 = (forearm.*m5.*sin(th1 - th2 + th3 - th4 - th5).*(crus.*th1ddot.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1ddot - th2ddot + th3ddot - th4ddot) + (forearm.*sin(th1 - th2 + th3 - th4 - th5).*(th2ddot - th1ddot - th3ddot + th4ddot + th5ddot))/2 - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + crus.*th1dot.^2.*cos(th1) + spine.*sin(th1 - th2 + th3).*(th1ddot - th2ddot + th3ddot) + thigh.*sin(th1 - th2).*(th1ddot - th2ddot) - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2))/2 - (forearm.*g.*m5.*sin(th1 - th2 + th3 - th4 - th5))/2;



% motion plots
for i=1:length(t)
    
    % positions 
x_ankle= waist_width/2;
y_ankle= 0;
z_ankle= 0.05;

x_knee= x_ankle;
y_knee= y_ankle+crus.*sin(th1(i));
z_knee= z_ankle+ crus.*cos(th1(i));

x_waist= x_knee - waist_width/2;
y_waist= y_knee + thigh.*sin(th1(i)-th2(i));
z_waist= z_knee + thigh.*cos(th1(i)-th2(i));

x_shoulder= x_waist + shoulder/2;
y_shoulder= y_waist + spine.*sin(th1(i)-th2(i)+th3(i));
z_shoulder= z_waist + spine.*cos(th1(i)-th2(i)+th3(i));

x_elbow= x_shoulder;
y_elbow= y_shoulder + bicep_arm.*sin(th1(i)-th2(i)+th3(i)-th4(i)-pi);
z_elbow= z_shoulder +bicep_arm.*cos(th1(i)-th2(i)+th3(i)-th4(i)-pi);

x_wrist= x_elbow;
y_wrist= y_elbow + forearm.*sin(th1(i)-th2(i)+th3(i)-th4(i)-th5(i)-pi);
z_wrist= z_elbow + forearm.*cos(th1(i)-th2(i)+th3(i)-th4(i)-th5(i)-pi);
    
X=[ x_ankle x_knee x_waist x_shoulder x_elbow x_wrist];
Y=[ y_ankle y_knee y_waist y_shoulder y_elbow y_wrist];
Z=[ z_ankle z_knee z_waist z_shoulder z_elbow z_wrist];

subplot(1,2,1)
a=plot(Y,Z, 'k*-');
set(a,'LineWidth',2);
axis([-1 1 0 2]);
grid on;


subplot(1,2,2)
plot(t(1:i),tau5(1:i),'g');
% axis([0 10 -50 10]);
title('elbow')
xlabel('time(s)')
ylabel('Torque(Nm)')

pause(dt)


end



% Coriolis vector components:  obtained by assigning all thddot and g components to 0.

C1= m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)).*(crus.*th1dot.^2.*cos(th1) - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - m5.*(crus.*th1dot.^2.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2).*(spine.*cos(th1 - th2 + th3) - bicep_arm.*cos(th1 - th2 + th3 - th4) + crus.*cos(th1) + thigh.*cos(th1 - th2)) - m3.*(crus.*th1dot.^2.*sin(th1) + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2).*(crus.*cos(th1) + thigh.*cos(th1 - th2)) + m2.*(crus.*th1dot.^2.*cos(th1) + (thigh.*cos(th1 - th2).*(th1dot - th2dot).^2)/2).*(crus.*sin(th1) + (thigh.*sin(th1 - th2))/2) - m4.*(spine.*cos(th1 - th2 + th3) + crus.*cos(th1) + thigh.*cos(th1 - th2)).*(crus.*th1dot.^2.*sin(th1) + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) + m3.*((spine.*sin(th1 - th2 + th3))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)).*(crus.*th1dot.^2.*cos(th1) + (spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2)/2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + m5.*(spine.*sin(th1 - th2 + th3) - bicep_arm.*sin(th1 - th2 + th3 - th4) + crus.*sin(th1) + thigh.*sin(th1 - th2) - (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1dot.^2.*cos(th1) - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + (crus.^2.*m1.*th1dot.^2.*cos(th1).*sin(th1))/4 - crus.^2.*m2.*th1dot.^2.*cos(th1).*sin(th1);
C2= m4.*(spine.*cos(th1 - th2 + th3) + thigh.*cos(th1 - th2)).*(crus.*th1dot.^2.*sin(th1) + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) + m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) - thigh.*sin(th1 - th2) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1dot.^2.*cos(th1) - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + thigh.*sin(th1 - th2)).*(crus.*th1dot.^2.*cos(th1) - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + m5.*(spine.*cos(th1 - th2 + th3) - bicep_arm.*cos(th1 - th2 + th3 - th4) + thigh.*cos(th1 - th2)).*(crus.*th1dot.^2.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) - m3.*((spine.*sin(th1 - th2 + th3))/2 + thigh.*sin(th1 - th2)).*(crus.*th1dot.^2.*cos(th1) + (spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2)/2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - (m2.*thigh.*sin(th1 - th2).*(crus.*th1dot.^2.*cos(th1) + (thigh.*cos(th1 - th2).*(th1dot - th2dot).^2)/2))/2 + m3.*thigh.*cos(th1 - th2).*(crus.*th1dot.^2.*sin(th1) + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2);
C3=m5.*(bicep_arm.*cos(th1 - th2 + th3 - th4) - spine.*cos(th1 - th2 + th3)).*(crus.*th1dot.^2.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2) - m4.*((bicep_arm.*sin(th1 - th2 + th3 - th4))/2 - spine.*sin(th1 - th2 + th3)).*(crus.*th1dot.^2.*cos(th1) - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) - m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1dot.^2.*cos(th1) - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + (m3.*spine.*sin(th1 - th2 + th3).*(crus.*th1dot.^2.*cos(th1) + (spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2)/2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2))/2 - m4.*spine.*cos(th1 - th2 + th3).*(crus.*th1dot.^2.*sin(th1) + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2);
C4=m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2).*(crus.*th1dot.^2.*cos(th1) - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2) + (bicep_arm.*m4.*sin(th1 - th2 + th3 - th4).*(crus.*th1dot.^2.*cos(th1) - (bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2))/2 - bicep_arm.*m5.*cos(th1 - th2 + th3 - th4).*(crus.*th1dot.^2.*sin(th1) - bicep_arm.*sin(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 + spine.*sin(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*sin(th1 - th2).*(th1dot - th2dot).^2);
C5=(forearm.*m5.*sin(th1 - th2 + th3 - th4 - th5).*(crus.*th1dot.^2.*cos(th1) - bicep_arm.*cos(th1 - th2 + th3 - th4).*(th1dot - th2dot + th3dot - th4dot).^2 - (forearm.*cos(th1 - th2 + th3 - th4 - th5).*(th2dot - th1dot - th3dot + th4dot + th5dot).^2)/2 + spine.*cos(th1 - th2 + th3).*(th1dot - th2dot + th3dot).^2 + thigh.*cos(th1 - th2).*(th1dot - th2dot).^2))/2;


C=[C1;C2;C3;C4;C5];

m11=(bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (crus.^2.*m1)/8 + crus.^2.*m2 + crus.^2.*m3 + crus.^2.*m4 + crus.^2.*m5 + (forearm.^2.*m5)/8 + (m3.*spine.^2)/8 + m4.*spine.^2 + m5.*spine.^2 + (m2.*thigh.^2)/8 + m3.*thigh.^2 + m4.*thigh.^2 + m5.*thigh.^2 - (m2.*thigh.^2.*cos(2.*th1 - 2.*th2))/8 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 - (crus.^2.*m1.*cos(2.*th1))/8 - (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 - (crus.*m2.*thigh.*cos(2.*th1 - th2))/2 - (bicep_arm.*crus.*m4.*cos(th2 - th3 + th4))/2 - 2.*bicep_arm.*crus.*m5.*cos(th2 - th3 + th4) + (crus.*forearm.*m5.*cos(2.*th1 - th2 + th3 - th4 - th5))/2 + (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/2 + (bicep_arm.*crus.*m4.*cos(2.*th1 - th2 + th3 - th4))/2 - (forearm.*m5.*spine.*cos(th4 + th5))/2 + (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/2 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*m4.*spine.*cos(th4))/2 - 2.*bicep_arm.*m5.*spine.*cos(th4) - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 + (crus.*m2.*thigh.*cos(th2))/2 + 2.*crus.*m3.*thigh.*cos(th2) + 2.*crus.*m4.*thigh.*cos(th2) + 2.*crus.*m5.*thigh.*cos(th2) - (crus.*m3.*spine.*cos(2.*th1 - th2 + th3))/2 - (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/2 - (crus.*forearm.*m5.*cos(th2 - th3 + th4 + th5))/2 + (m3.*spine.*thigh.*cos(th3))/2 + 2.*m4.*spine.*thigh.*cos(th3) + 2.*m5.*spine.*thigh.*cos(th3) + (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 - (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/2 - (bicep_arm.*m4.*thigh.*cos(th3 - th4))/2 - 2.*bicep_arm.*m5.*thigh.*cos(th3 - th4) + (crus.*m3.*spine.*cos(th2 - th3))/2 + 2.*crus.*m4.*spine.*cos(th2 - th3) + 2.*crus.*m5.*spine.*cos(th2 - th3) + (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m12=(m2.*thigh.^2.*cos(2.*th1 - 2.*th2))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (m3.*spine.^2)/8 - m4.*spine.^2 - m5.*spine.^2 - (m2.*thigh.^2)/8 - m3.*thigh.^2 - m4.*thigh.^2 - m5.*thigh.^2 - (bicep_arm.^2.*m4)/8 + (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 + (crus.*m2.*thigh.*cos(2.*th1 - th2))/4 + (bicep_arm.*crus.*m4.*cos(th2 - th3 + th4))/4 + bicep_arm.*crus.*m5.*cos(th2 - th3 + th4) - (crus.*forearm.*m5.*cos(2.*th1 - th2 + th3 - th4 - th5))/4 - (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/2 - (bicep_arm.*crus.*m4.*cos(2.*th1 - th2 + th3 - th4))/4 + (forearm.*m5.*spine.*cos(th4 + th5))/2 - (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/2 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/2 + 2.*bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (crus.*m2.*thigh.*cos(th2))/4 - crus.*m3.*thigh.*cos(th2) - crus.*m4.*thigh.*cos(th2) - crus.*m5.*thigh.*cos(th2) + (crus.*m3.*spine.*cos(2.*th1 - th2 + th3))/4 + (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/2 + (crus.*forearm.*m5.*cos(th2 - th3 + th4 + th5))/4 - (m3.*spine.*thigh.*cos(th3))/2 - 2.*m4.*spine.*thigh.*cos(th3) - 2.*m5.*spine.*thigh.*cos(th3) - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 + (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/2 + (bicep_arm.*m4.*thigh.*cos(th3 - th4))/2 + 2.*bicep_arm.*m5.*thigh.*cos(th3 - th4) - (crus.*m3.*spine.*cos(th2 - th3))/4 - crus.*m4.*spine.*cos(th2 - th3) - crus.*m5.*spine.*cos(th2 - th3) - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m13=(bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (forearm.^2.*m5)/8 + (m3.*spine.^2)/8 + m4.*spine.^2 + m5.*spine.^2 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 - (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 - (bicep_arm.*crus.*m4.*cos(th2 - th3 + th4))/4 - bicep_arm.*crus.*m5.*cos(th2 - th3 + th4) + (crus.*forearm.*m5.*cos(2.*th1 - th2 + th3 - th4 - th5))/4 + (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 + (bicep_arm.*crus.*m4.*cos(2.*th1 - th2 + th3 - th4))/4 - (forearm.*m5.*spine.*cos(th4 + th5))/2 + (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*m4.*spine.*cos(th4))/2 - 2.*bicep_arm.*m5.*spine.*cos(th4) - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (crus.*m3.*spine.*cos(2.*th1 - th2 + th3))/4 - (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 - (crus.*forearm.*m5.*cos(th2 - th3 + th4 + th5))/4 + (m3.*spine.*thigh.*cos(th3))/4 + m4.*spine.*thigh.*cos(th3) + m5.*spine.*thigh.*cos(th3) + (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 - (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/4 - (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 - bicep_arm.*m5.*thigh.*cos(th3 - th4) + (crus.*m3.*spine.*cos(th2 - th3))/4 + crus.*m4.*spine.*cos(th2 - th3) + crus.*m5.*spine.*cos(th2 - th3) + (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m14=(forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (bicep_arm.^2.*m4)/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (bicep_arm.*crus.*m4.*cos(th2 - th3 + th4))/4 + bicep_arm.*crus.*m5.*cos(th2 - th3 + th4) - (crus.*forearm.*m5.*cos(2.*th1 - th2 + th3 - th4 - th5))/4 - (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 - (bicep_arm.*crus.*m4.*cos(2.*th1 - th2 + th3 - th4))/4 + (forearm.*m5.*spine.*cos(th4 + th5))/4 - (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/4 + bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 + (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 + (crus.*forearm.*m5.*cos(th2 - th3 + th4 + th5))/4 - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/4 + (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 + bicep_arm.*m5.*thigh.*cos(th3 - th4) - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/4;
m15=-(forearm.*m5.*(forearm + 2.*crus.*cos(2.*th1 - th2 + th3 - th4 - th5) + 2.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5) - 2.*spine.*cos(th4 + th5) + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5) - 2.*thigh.*cos(th3 - th4 - th5) - 2.*crus.*cos(th2 - th3 + th4 + th5) + 2.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5)))/8;


m21=(m2.*thigh.^2.*cos(2.*th1 - 2.*th2))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (m3.*spine.^2)/8 - m4.*spine.^2 - m5.*spine.^2 - (m2.*thigh.^2)/8 - m3.*thigh.^2 - m4.*thigh.^2 - m5.*thigh.^2 - (bicep_arm.^2.*m4)/8 + (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 + (crus.*m2.*thigh.*cos(2.*th1 - th2))/4 + (bicep_arm.*crus.*m4.*cos(th2 - th3 + th4))/4 + bicep_arm.*crus.*m5.*cos(th2 - th3 + th4) - (crus.*forearm.*m5.*cos(2.*th1 - th2 + th3 - th4 - th5))/4 - (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/2 - (bicep_arm.*crus.*m4.*cos(2.*th1 - th2 + th3 - th4))/4 + (forearm.*m5.*spine.*cos(th4 + th5))/2 - (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/2 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/2 + 2.*bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (crus.*m2.*thigh.*cos(th2))/4 - crus.*m3.*thigh.*cos(th2) - crus.*m4.*thigh.*cos(th2) - crus.*m5.*thigh.*cos(th2) + (crus.*m3.*spine.*cos(2.*th1 - th2 + th3))/4 + (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/2 + (crus.*forearm.*m5.*cos(th2 - th3 + th4 + th5))/4 - (m3.*spine.*thigh.*cos(th3))/2 - 2.*m4.*spine.*thigh.*cos(th3) - 2.*m5.*spine.*thigh.*cos(th3) - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 + (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/2 + (bicep_arm.*m4.*thigh.*cos(th3 - th4))/2 + 2.*bicep_arm.*m5.*thigh.*cos(th3 - th4) - (crus.*m3.*spine.*cos(th2 - th3))/4 - crus.*m4.*spine.*cos(th2 - th3) - crus.*m5.*spine.*cos(th2 - th3) - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m22=(bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (forearm.^2.*m5)/8 + (m3.*spine.^2)/8 + m4.*spine.^2 + m5.*spine.^2 + (m2.*thigh.^2)/8 + m3.*thigh.^2 + m4.*thigh.^2 + m5.*thigh.^2 - (m2.*thigh.^2.*cos(2.*th1 - 2.*th2))/8 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 - (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 + (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/2 - (forearm.*m5.*spine.*cos(th4 + th5))/2 + (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/2 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*m4.*spine.*cos(th4))/2 - 2.*bicep_arm.*m5.*spine.*cos(th4) - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/2 + (m3.*spine.*thigh.*cos(th3))/2 + 2.*m4.*spine.*thigh.*cos(th3) + 2.*m5.*spine.*thigh.*cos(th3) + (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 - (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/2 - (bicep_arm.*m4.*thigh.*cos(th3 - th4))/2 - 2.*bicep_arm.*m5.*thigh.*cos(th3 - th4) + (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m23=(forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (m3.*spine.^2)/8 - m4.*spine.^2 - m5.*spine.^2 - (bicep_arm.^2.*m4)/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 - (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 + (forearm.*m5.*spine.*cos(th4 + th5))/2 - (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/2 + 2.*bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 + (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 - (m3.*spine.*thigh.*cos(th3))/4 - m4.*spine.*thigh.*cos(th3) - m5.*spine.*thigh.*cos(th3) - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 + (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/4 + (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 + bicep_arm.*m5.*thigh.*cos(th3 - th4) - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m24=(bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (forearm.^2.*m5)/8 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 - (forearm.*m5.*spine.*cos(th4 + th5))/4 + (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*m4.*spine.*cos(th4))/4 - bicep_arm.*m5.*spine.*cos(th4) - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 + (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/4 - (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 - bicep_arm.*m5.*thigh.*cos(th3 - th4) + (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/4;
m25=(forearm.*m5.*(forearm + 2.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5) - 2.*spine.*cos(th4 + th5) + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5) - 2.*thigh.*cos(th3 - th4 - th5) + 2.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5)))/8;


m31=(bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (forearm.^2.*m5)/8 + (m3.*spine.^2)/8 + m4.*spine.^2 + m5.*spine.^2 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 - (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 - (bicep_arm.*crus.*m4.*cos(th2 - th3 + th4))/4 - bicep_arm.*crus.*m5.*cos(th2 - th3 + th4) + (crus.*forearm.*m5.*cos(2.*th1 - th2 + th3 - th4 - th5))/4 + (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 + (bicep_arm.*crus.*m4.*cos(2.*th1 - th2 + th3 - th4))/4 - (forearm.*m5.*spine.*cos(th4 + th5))/2 + (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*m4.*spine.*cos(th4))/2 - 2.*bicep_arm.*m5.*spine.*cos(th4) - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (crus.*m3.*spine.*cos(2.*th1 - th2 + th3))/4 - (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 - (crus.*forearm.*m5.*cos(th2 - th3 + th4 + th5))/4 + (m3.*spine.*thigh.*cos(th3))/4 + m4.*spine.*thigh.*cos(th3) + m5.*spine.*thigh.*cos(th3) + (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 - (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/4 - (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 - bicep_arm.*m5.*thigh.*cos(th3 - th4) + (crus.*m3.*spine.*cos(th2 - th3))/4 + crus.*m4.*spine.*cos(th2 - th3) + crus.*m5.*spine.*cos(th2 - th3) + (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m32=(forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (m3.*spine.^2)/8 - m4.*spine.^2 - m5.*spine.^2 - (bicep_arm.^2.*m4)/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 - (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 + (forearm.*m5.*spine.*cos(th4 + th5))/2 - (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/2 + 2.*bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 + (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 - (m3.*spine.*thigh.*cos(th3))/4 - m4.*spine.*thigh.*cos(th3) - m5.*spine.*thigh.*cos(th3) - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 + (m3.*spine.*thigh.*cos(2.*th1 - 2.*th2 + th3))/4 + (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 + bicep_arm.*m5.*thigh.*cos(th3 - th4) - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m33=(bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (forearm.^2.*m5)/8 + (m3.*spine.^2)/8 + m4.*spine.^2 + m5.*spine.^2 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 - (m3.*spine.^2.*cos(2.*th1 - 2.*th2 + 2.*th3))/8 - (forearm.*m5.*spine.*cos(th4 + th5))/2 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*m4.*spine.*cos(th4))/2 - 2.*bicep_arm.*m5.*spine.*cos(th4) - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 + (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/2 + (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/2;
m34=(forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (bicep_arm.^2.*m4)/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (forearm.*m5.*spine.*cos(th4 + th5))/4 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/4 + bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/4 - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/4;
m35=-(forearm.*m5.*(forearm - 2.*spine.*cos(th4 + th5) + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5) + 2.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5)))/8;


m41=(forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (bicep_arm.^2.*m4)/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (bicep_arm.*crus.*m4.*cos(th2 - th3 + th4))/4 + bicep_arm.*crus.*m5.*cos(th2 - th3 + th4) - (crus.*forearm.*m5.*cos(2.*th1 - th2 + th3 - th4 - th5))/4 - (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 - (bicep_arm.*crus.*m4.*cos(2.*th1 - th2 + th3 - th4))/4 + (forearm.*m5.*spine.*cos(th4 + th5))/4 - (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/4 + bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 + (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 + (crus.*forearm.*m5.*cos(th2 - th3 + th4 + th5))/4 - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/4 + (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 + bicep_arm.*m5.*thigh.*cos(th3 - th4) - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/4;
m42=(bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (forearm.^2.*m5)/8 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (forearm.*m5.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5))/4 - (forearm.*m5.*spine.*cos(th4 + th5))/4 + (bicep_arm.*m4.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4))/4 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*m4.*spine.*cos(th4))/4 - bicep_arm.*m5.*spine.*cos(th4) - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (forearm.*m5.*thigh.*cos(th3 - th4 - th5))/4 + (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/4 - (bicep_arm.*m4.*thigh.*cos(th3 - th4))/4 - bicep_arm.*m5.*thigh.*cos(th3 - th4) + (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/4;
m43=(forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - bicep_arm.^2.*m5 - (forearm.^2.*m5)/8 - (bicep_arm.^2.*m4)/8 + (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (forearm.*m5.*spine.*cos(th4 + th5))/4 - (bicep_arm.*forearm.*m5.*cos(th5))/2 + (bicep_arm.*m4.*spine.*cos(th4))/4 + bicep_arm.*m5.*spine.*cos(th4) + (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2 - (forearm.*m5.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5))/4 - (bicep_arm.*m4.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4))/4;
m44= (bicep_arm.^2.*m4)/8 + bicep_arm.^2.*m5 + (forearm.^2.*m5)/8 - (forearm.^2.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5))/8 - (bicep_arm.^2.*m4.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4))/8 + (bicep_arm.*forearm.*m5.*cos(th5))/2 - (bicep_arm.*forearm.*m5.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5))/2;
m45= (forearm.*m5.*(forearm + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5)))/8;
 
 
m51= -(forearm.*m5.*(forearm + 2.*crus.*cos(2.*th1 - th2 + th3 - th4 - th5) + 2.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5) - 2.*spine.*cos(th4 + th5) + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5) - 2.*thigh.*cos(th3 - th4 - th5) - 2.*crus.*cos(th2 - th3 + th4 + th5) + 2.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5)))/8;
m52= (forearm.*m5.*(forearm + 2.*thigh.*cos(2.*th1 - 2.*th2 + th3 - th4 - th5) - 2.*spine.*cos(th4 + th5) + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5) - 2.*thigh.*cos(th3 - th4 - th5) + 2.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5)))/8;
m53=-(forearm.*m5.*(forearm - 2.*spine.*cos(th4 + th5) + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5) + 2.*spine.*cos(2.*th1 - 2.*th2 + 2.*th3 - th4 - th5)))/8;
m54= (forearm.*m5.*(forearm + 2.*bicep_arm.*cos(th5) - 2.*bicep_arm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - th5) - forearm.*cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5)))/8;
m55= -(forearm.^2.*m5.*(cos(2.*th1 - 2.*th2 + 2.*th3 - 2.*th4 - 2.*th5) - 1))/8; 

M=cell(5,5);
M{1,1}=m11; M{1,2}=m12;M{1,3}=m13;M{1,4}=m14;M{1,5}=m15; 
M{2,1}=m21; M{2,2}=m22;M{2,3}=m23;M{2,4}=m24;M{2,5}=m25;
M{3,1}=m31; M{3,2}=m32;M{3,3}=m33;M{3,4}=m34;M{3,5}=m35;
M{4,1}=m41; M{4,2}=m42;M{4,3}=m43;M{4,4}=m44;M{4,5}=m45;
M{5,1}=m51; M{5,2}=m52;M{5,3}=m53;M{5,4}=m54;M{5,5}=m55;

% M=[ m11 m12 m13 m14 m15; m21 m22 m23 m24 m25;m31 m32 m33 m34 m35;m41 m42 m43 m44 m45;m51 m52 m53 m54 m55 ];

% Gravity vector
G1=- g.*m2.*(crus.*sin(th1) + (thigh.*sin(th1 - th2))/2) - g.*m3.*((spine.*sin(th1 - th2 + th3))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)) - g.*m5.*(spine.*sin(th1 - th2 + th3) - bicep_arm.*sin(th1 - th2 + th3 - th4) + crus.*sin(th1) + thigh.*sin(th1 - th2) - (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) - g.*m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + crus.*sin(th1) + thigh.*sin(th1 - th2)) - (crus.*g.*m1.*sin(th1))/2;
G2= g.*m4.*(spine.*sin(th1 - th2 + th3) - (bicep_arm.*sin(th1 - th2 + th3 - th4))/2 + thigh.*sin(th1 - th2)) - g.*m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) - thigh.*sin(th1 - th2) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) + g.*m3.*((spine.*sin(th1 - th2 + th3))/2 + thigh.*sin(th1 - th2)) + (g.*m2.*thigh.*sin(th1 - th2))/2;
G3= g.*m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) - spine.*sin(th1 - th2 + th3) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) + g.*m4.*((bicep_arm.*sin(th1 - th2 + th3 - th4))/2 - spine.*sin(th1 - th2 + th3)) - (g.*m3.*spine.*sin(th1 - th2 + th3))/2;
G4=- g.*m5.*(bicep_arm.*sin(th1 - th2 + th3 - th4) + (forearm.*sin(th1 - th2 + th3 - th4 - th5))/2) - (bicep_arm.*g.*m4.*sin(th1 - th2 + th3 - th4))/2;
G5=-(forearm.*g.*m5.*sin(th1 - th2 + th3 - th4 - th5))/2;

G=[G1;G2;G3;G4;G5];

MTHDOT=zeros(size(thddot));
for i=1:5
    for j=1:5
       MTHDOT(i,:)=MTHDOT(i,:)+ M{i,j}.*thddot(j,:);
    end
end
tau=MTHDOT +C+G;

